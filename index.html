<!DOCTYPE html>
<html lang="en">
    <head>
        <link href="https://fonts.googleapis.com/css?family=Press+Start+2P" rel="stylesheet">
        <link href="https://unpkg.com/nes.css@2.3.0/css/nes.min.css" rel="stylesheet" />
        <style>
            body {
                width:100%;
                display:flex;
                flex-flow:column;
                align-items:center;
            }

            header {
                width: 100%;
                text-align: center;
            }

            main {
                min-width: 500px;
                max-width: 900px;
            }

            #model-container {
                margin-top: 12px;
                margin-bottom: 12px;
                min-width: 800px;
                min-height: 800px;
            }

            #render-container {
                border-radius: 30%;
            }

            #stl-render {
                margin: 2px;
                min-width: 795px;
                min-height: 795px;
                background-color: #000;
            }

            .preview-image {
                width: 128px;
                height: 128px;
            }

            .model-cell-content {
                display: flex;
                flex-flow: column;
                justify-content: flex-start;
            }

            .name {
                display: block;
            }
        </style>
    </head>
    <body>
        <header>
            <h1>Freemasen's Models</h1>
        </header>
        <main>
            <div id="model-container" class="nes-container with-title is-dark">
                <h2 id="stl-title" class="title">Model</h2>
                <div id="render-container">
                    <div id="stl-render">Select Model Below</div>
                </div>
            </div>
            <div id="file-list" class="nes-container with-title is-dark">
                <h2 class="title">Files</h2>
                <table class="nes-table is-bordered is-centered is-dark">
                    <thead>
                        <tr>
                            <th>Model</th>
                            <th>Render</th>
                            <th>Download<br />.stl</th>
                        </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td>
                            <div class="model-cell-content">
                                <span class="name nes-text" id="CanStand2.0">CanStand2.0</span>
                                <img class="preview-image" src="img/CanStand2.0.png" />
                            </div>
                        </td>
                        <td>
                            <button class="nes-btn render-button" data-name="CanStand2.0" data-path="renders/CanStand2.0.stl" title="render">></button>
                        </td>
                        <td><a class="nes-btn" href="renders/CanStand2.0.stl" download="renders/CanStand2.0.stl" title="download">V</a></td>
                    </tr>
                    <tr>
                        <td>
                            <div class="model-cell-content">
                                <span class="name nes-text" id="CanStand3.0-Short">CanStand3.0-Short</span>
                                <img class="preview-image" src="img/CanStand3.0-Short.png" />
                            </div>
                        </td>
                        <td>
                            <button class="nes-btn render-button" data-name="CanStand3.0-Short" data-path="renders/CanStand3.0-Short.stl" title="render">></button>
                        </td>
                        <td><a class="nes-btn" href="renders/CanStand3.0-Short.stl" download="renders/CanStand3.0-Short.stl" title="download">V</a></td>
                    </tr>
                    <tr>
                        <td>
                            <div class="model-cell-content">
                                <span class="name nes-text" id="CanStand3.0-Tall">CanStand3.0-Tall</span>
                                <img class="preview-image" src="img/CanStand3.0-Tall.png" />
                            </div>
                        </td>
                        <td>
                            <button class="nes-btn render-button" data-name="CanStand3.0-Tall" data-path="renders/CanStand3.0-Tall.stl" title="render">></button>
                        </td>
                        <td><a class="nes-btn" href="renders/CanStand3.0-Tall.stl" download="renders/CanStand3.0-Tall.stl" title="download">V</a></td>
                    </tr>
                    <tr>
                        <td>
                            <div class="model-cell-content">
                                <span class="name nes-text" id="art-hook-a">art-hook-a</span>
                                <img class="preview-image" src="img/art-hook-a.png" />
                            </div>
                        </td>
                        <td>
                            <button class="nes-btn render-button" data-name="art-hook-a" data-path="renders/art-hook-a.stl" title="render">></button>
                        </td>
                        <td><a class="nes-btn" href="renders/art-hook-a.stl" download="renders/art-hook-a.stl" title="download">V</a></td>
                    </tr>
                    <tr>
                        <td>
                            <div class="model-cell-content">
                                <span class="name nes-text" id="art-hook-b">art-hook-b</span>
                                <img class="preview-image" src="img/art-hook-b.png" />
                            </div>
                        </td>
                        <td>
                            <button class="nes-btn render-button" data-name="art-hook-b" data-path="renders/art-hook-b.stl" title="render">></button>
                        </td>
                        <td><a class="nes-btn" href="renders/art-hook-b.stl" download="renders/art-hook-b.stl" title="download">V</a></td>
                    </tr>
                    <tr>
                        <td>
                            <div class="model-cell-content">
                                <span class="name nes-text" id="candelHolder">candelHolder</span>
                                <img class="preview-image" src="img/candelHolder.png" />
                            </div>
                        </td>
                        <td>
                            <button class="nes-btn render-button" data-name="candelHolder" data-path="renders/candelHolder.stl" title="render">></button>
                        </td>
                        <td><a class="nes-btn" href="renders/candelHolder.stl" download="renders/candelHolder.stl" title="download">V</a></td>
                    </tr>
                    <tr>
                        <td>
                            <div class="model-cell-content">
                                <span class="name nes-text" id="pegboard-mount-cap">pegboard-mount-cap</span>
                                <img class="preview-image" src="img/pegboard-mount-cap.png" />
                            </div>
                        </td>
                        <td>
                            <button class="nes-btn render-button" data-name="pegboard-mount-cap" data-path="renders/pegboard-mount-cap.stl" title="render">></button>
                        </td>
                        <td><a class="nes-btn" href="renders/pegboard-mount-cap.stl" download="renders/pegboard-mount-cap.stl" title="download">V</a></td>
                    </tr>
                    <tr>
                        <td>
                            <div class="model-cell-content">
                                <span class="name nes-text" id="pegboard-mount">pegboard-mount</span>
                                <img class="preview-image" src="img/pegboard-mount.png" />
                            </div>
                        </td>
                        <td>
                            <button class="nes-btn render-button" data-name="pegboard-mount" data-path="renders/pegboard-mount.stl" title="render">></button>
                        </td>
                        <td><a class="nes-btn" href="renders/pegboard-mount.stl" download="renders/pegboard-mount.stl" title="download">V</a></td>
                    </tr>
                    <tr>
                        <td>
                            <div class="model-cell-content">
                                <span class="name nes-text" id="small-tree-stand">small-tree-stand</span>
                                <img class="preview-image" src="img/small-tree-stand.png" />
                            </div>
                        </td>
                        <td>
                            <button class="nes-btn render-button" data-name="small-tree-stand" data-path="renders/small-tree-stand.stl" title="render">></button>
                        </td>
                        <td><a class="nes-btn" href="renders/small-tree-stand.stl" download="renders/small-tree-stand.stl" title="download">V</a></td>
                    </tr>
                    <tr>
                        <td>
                            <div class="model-cell-content">
                                <span class="name nes-text" id="spinner_cylinderAttacher">spinner_cylinderAttacher</span>
                                <img class="preview-image" src="img/spinner/cylinderAttacher.png" />
                            </div>
                        </td>
                        <td>
                            <button class="nes-btn render-button" data-name="spinner_cylinderAttacher" data-path="renders/spinner/cylinderAttacher.stl" title="render">></button>
                        </td>
                        <td><a class="nes-btn" href="renders/spinner/cylinderAttacher.stl" download="renders/spinner/cylinderAttacher.stl" title="download">V</a></td>
                    </tr>
                    <tr>
                        <td>
                            <div class="model-cell-content">
                                <span class="name nes-text" id="spinner_postSupport">spinner_postSupport</span>
                                <img class="preview-image" src="img/spinner/postSupport.png" />
                            </div>
                        </td>
                        <td>
                            <button class="nes-btn render-button" data-name="spinner_postSupport" data-path="renders/spinner/postSupport.stl" title="render">></button>
                        </td>
                        <td><a class="nes-btn" href="renders/spinner/postSupport.stl" download="renders/spinner/postSupport.stl" title="download">V</a></td>
                    </tr>
                    <tr>
                        <td>
                            <div class="model-cell-content">
                                <span class="name nes-text" id="spinner_spinner">spinner_spinner</span>
                                <img class="preview-image" src="img/spinner/spinner.png" />
                            </div>
                        </td>
                        <td>
                            <button class="nes-btn render-button" data-name="spinner_spinner" data-path="renders/spinner/spinner.stl" title="render">></button>
                        </td>
                        <td><a class="nes-btn" href="renders/spinner/spinner.stl" download="renders/spinner/spinner.stl" title="download">V</a></td>
                    </tr>
                    <tr>
                        <td>
                            <div class="model-cell-content">
                                <span class="name nes-text" id="spinner_spinnerCylindar">spinner_spinnerCylindar</span>
                                <img class="preview-image" src="img/spinner/spinnerCylindar.png" />
                            </div>
                        </td>
                        <td>
                            <button class="nes-btn render-button" data-name="spinner_spinnerCylindar" data-path="renders/spinner/spinnerCylindar.stl" title="render">></button>
                        </td>
                        <td><a class="nes-btn" href="renders/spinner/spinnerCylindar.stl" download="renders/spinner/spinnerCylindar.stl" title="download">V</a></td>
                    </tr>
                    <tr>
                        <td>
                            <div class="model-cell-content">
                                <span class="name nes-text" id="spinner_spinnerLargeWheel">spinner_spinnerLargeWheel</span>
                                <img class="preview-image" src="img/spinner/spinnerLargeWheel.png" />
                            </div>
                        </td>
                        <td>
                            <button class="nes-btn render-button" data-name="spinner_spinnerLargeWheel" data-path="renders/spinner/spinnerLargeWheel.stl" title="render">></button>
                        </td>
                        <td><a class="nes-btn" href="renders/spinner/spinnerLargeWheel.stl" download="renders/spinner/spinnerLargeWheel.stl" title="download">V</a></td>
                    </tr>
                    <tr>
                        <td>
                            <div class="model-cell-content">
                                <span class="name nes-text" id="spinner_spinnerSmallWheel">spinner_spinnerSmallWheel</span>
                                <img class="preview-image" src="img/spinner/spinnerSmallWheel.png" />
                            </div>
                        </td>
                        <td>
                            <button class="nes-btn render-button" data-name="spinner_spinnerSmallWheel" data-path="renders/spinner/spinnerSmallWheel.stl" title="render">></button>
                        </td>
                        <td><a class="nes-btn" href="renders/spinner/spinnerSmallWheel.stl" download="renders/spinner/spinnerSmallWheel.stl" title="download">V</a></td>
                    </tr>
                    <tr>
                        <td>
                            <div class="model-cell-content">
                                <span class="name nes-text" id="spinner_spinnerWheel">spinner_spinnerWheel</span>
                                <img class="preview-image" src="img/spinner/spinnerWheel.png" />
                            </div>
                        </td>
                        <td>
                            <button class="nes-btn render-button" data-name="spinner_spinnerWheel" data-path="renders/spinner/spinnerWheel.stl" title="render">></button>
                        </td>
                        <td><a class="nes-btn" href="renders/spinner/spinnerWheel.stl" download="renders/spinner/spinnerWheel.stl" title="download">V</a></td>
                    </tr>
                    <tr>
                        <td>
                            <div class="model-cell-content">
                                <span class="name nes-text" id="spinner_stm32f101Enclosure">spinner_stm32f101Enclosure</span>
                                <img class="preview-image" src="img/spinner/stm32f101Enclosure.png" />
                            </div>
                        </td>
                        <td>
                            <button class="nes-btn render-button" data-name="spinner_stm32f101Enclosure" data-path="renders/spinner/stm32f101Enclosure.stl" title="render">></button>
                        </td>
                        <td><a class="nes-btn" href="renders/spinner/stm32f101Enclosure.stl" download="renders/spinner/stm32f101Enclosure.stl" title="download">V</a></td>
                    </tr>
                    <tr>
                        <td>
                            <div class="model-cell-content">
                                <span class="name nes-text" id="squareStencil">squareStencil</span>
                                <img class="preview-image" src="img/squareStencil.png" />
                            </div>
                        </td>
                        <td>
                            <button class="nes-btn render-button" data-name="squareStencil" data-path="renders/squareStencil.stl" title="render">></button>
                        </td>
                        <td><a class="nes-btn" href="renders/squareStencil.stl" download="renders/squareStencil.stl" title="download">V</a></td>
                    </tr>
                    <tr>
                        <td>
                            <div class="model-cell-content">
                                <span class="name nes-text" id="support-arch-module">support-arch-module</span>
                                <img class="preview-image" src="img/support-arch-module.png" />
                            </div>
                        </td>
                        <td>
                            <button class="nes-btn render-button" data-name="support-arch-module" data-path="renders/support-arch-module.stl" title="render">></button>
                        </td>
                        <td><a class="nes-btn" href="renders/support-arch-module.stl" download="renders/support-arch-module.stl" title="download">V</a></td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </main>
        <script type="importmap">
            {
                "imports": {
                    "three": "https://cdn.jsdelivr.net/npm/three@0.179.1/build/three.module.js",
                    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.179.1/examples/jsm/"
                }
            }
        </script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/dialog-polyfill/0.5.6/dialog-polyfill.min.js"
            integrity="sha512-qUIG93zKzcLBVD5RGRbx2PBmbVRu+tJIl+EPLTus0z8I1AMru9sQYdlf6cBacSzYmZVncB9rcc8rYBnazqgrxA=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <script type="module">
            import * as THREE from 'three';
            import Stats from 'three/addons/libs/stats.module.js';
            import { STLLoader } from 'three/addons/loaders/STLLoader.js';
            import { OrbitControls  } from 'three/addons/controls/OrbitControls.js';

            const RENDERED_TITLE_ID = "stl-title";
            const RENDERER_ID = "stl-render";
            const SELECTED_KEY = "selected-model";
            const SELECTED_NAME_KEY = "selected-model-name";

            /**
            * @type HTMLDivElement
            */
            let renderer_ele;
            let title_ele;

            for (let i = 0; i < 10; i++) {
                if (renderer_ele) {
                    break;
                }
                await new Promise(r => setTimeout(r, 300));
                renderer_ele = document.getElementById(RENDERER_ID);
                title_ele = document.getElementById(RENDERED_TITLE_ID);
            }

            let camera = new THREE.PerspectiveCamera(90, renderer_ele.clientWidth / renderer_ele.clientHeight, 1, 1000);
            let renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(renderer_ele.clientWidth, renderer_ele.clientHeight);
            renderer_ele.appendChild(renderer.domElement);
            let controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.enableRotate = true;
            controls.dampingFactor = 0.1;
            controls.enableZoom = true;
            let animate = (scene, diff) => {
                controls.update();
                renderer.render(scene, camera);
                requestAnimationFrame(diff => {
                    return animate(scene, diff)
                });
            };
            let render_model = async (path, name) => {
                for (let ele of Array.from(document.querySelectorAll(".name"))) {
                    ele.classList.remove("is-primary");
                }
                document.getElementById(name).classList.add("is-primary");
                title_ele.innerText = name || "Model";
                while (renderer_ele.hasChildNodes()) {
                    renderer_ele.removeChild(renderer_ele.lastChild);
                }
                renderer_ele.appendChild(renderer.domElement);
                let scene = new THREE.Scene();
                scene.background = 0x010101;
                scene.add(new THREE.HemisphereLight(0xefefef, 1.5));
                scene.add(new THREE.DirectionalLight(0xffffff, 0.5));
                let loader = new STLLoader();
                let geometry = await new Promise((r, j) => {
                    console.log("trying to load", path);
                    try {
                        loader.load(path, (geo) => {
                            console.log("resolved geo", geo);
                            return r(geo);
                        });
                    } catch (e) {
                        return j(e);
                    }
                });
                let material = new THREE.MeshPhongMaterial({
                    color: 0xffffff,
                    specular: 0,
                    shininess: 0,
                    flatShading: true,
                });
                let mesh = new THREE.Mesh(geometry, material);
                scene.add(mesh);
                let middle = new THREE.Vector3();
                geometry.computeBoundingBox();
                geometry.boundingBox.getCenter(middle);
                mesh.geometry
                    .applyMatrix4(new THREE.Matrix4()
                        .makeTranslation(middle.x, -middle.y, -middle.z));
                let largestDimension = Math.max(geometry.boundingBox.max.x,
                    geometry.boundingBox.max.y,
                    geometry.boundingBox.max.z)
                camera.position.z = largestDimension * 3;
                camera.fov = 70;
                requestAnimationFrame(diff => {
                    return animate(scene, diff)
                });
            };

            for (let btn of Array.from(document.querySelectorAll(".render-button"))) {
                btn.addEventListener("click", async () => {
                    console.log("clicked", btn.dataset.path, btn.dataset.name);
                    localStorage.setItem(SELECTED_KEY, btn.dataset.path);
                    localStorage.setItem(SELECTED_NAME_KEY, btn.dataset.name);
                    return await render_model(btn.dataset.path, btn.dataset.name);
                });
            }
            let current = localStorage.getItem(SELECTED_KEY);
            let name = localStorage.getItem(SELECTED_NAME_KEY);
            if (current) {
                await render_model(current, name);
            }
        </script>
    </body>
</html>
