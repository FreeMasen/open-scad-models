<!DOCTYPE html>
<html lang="en">
    <head>
        <link href="https://fonts.googleapis.com/css?family=Press+Start+2P" rel="stylesheet">
        <link href="https://unpkg.com/nes.css@2.3.0/css/nes.min.css" rel="stylesheet" />
        <style>
            body {
                width:100%;
                display:flex;
                flex-flow:column;
                align-items:center;
            }
            header {
                width: 100%;
                text-align: center;
            }
            main {
                min-width: 500px;
                max-width: 900px;
            }

            #stl-render {
                border-radius: 30%;
                margin: 2px;
                min-width: 795px;
                min-height: 795px;
                background-color: #fff;
            }

            #model-container {
                margin-top: 12px;
                margin-bottom: 12px;
                min-width: 800px;
                min-height: 800px;
            }
        </style>
    </head>
    <body>
        <header>
            <h1>Freemasen's Models</h1>
        </header>
        <main>
            <div id="file-list" class="nes-container with-title is-dark">
                <h2 class="title">Files</h2>
                <table class="nes-table is-bordered is-centered is-dark">
                    <thead>
                        <tr>
                            <th>Model</th>
                            <th>Render</th>
                            <th>Download<br />.stl</th>
                        </tr>
                    </thead>
                    <tbody>
                    {{#each stls}}
                    <tr>
                        <td>
                            <div>
                            <span>{{@key}}</span>
                            <img src="{{imgs[{{@key}}]}}" />
                            </div>
                            </td>
                        <td>
                            <button class="nes-btn render-button" data-path="renders/{{this}}"></button>
                        </td>
                        <td><a class="nes-btn" href="{{this}}" download="renders/{{this}}">V</a></td>
                    </tr>
                    {{/each}}
                    </tbody>
                </table>
            </div>
        </main>
        <div id="model-container" class="nes-container with-title is-dark">
            <h2 class="title">Model</h2>
            <div id="stl-render"></div>
        </div>
        <script type="importmap">
            {
                "imports": {
                    "three": "https://cdn.jsdelivr.net/npm/three@0.179.1/build/three.module.js",
                    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.179.1/examples/jsm/"
                }
            }
        </script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/dialog-polyfill/0.5.6/dialog-polyfill.min.js"
            integrity="sha512-qUIG93zKzcLBVD5RGRbx2PBmbVRu+tJIl+EPLTus0z8I1AMru9sQYdlf6cBacSzYmZVncB9rcc8rYBnazqgrxA=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <script type="module">
            import * as THREE from 'three';

            import Stats from 'three/addons/libs/stats.module.js';

            import { STLLoader } from 'three/addons/loaders/STLLoader.js';
            import { OrbitControls  } from 'three/addons/controls/OrbitControls.js'

            let elem = document.getElementById("stl-render");
            let camera = new THREE.PerspectiveCamera(70, elem.clientWidth / elem.clientHeight, 1, 1000);
            let renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(elem.clientWidth, elem.clientHeight);
            elem.appendChild(renderer.domElement);
            let controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.rotateSpeed = 0.05;
            controls.dampingFactor = 0.1;
            controls.enableZoom = true;
            controls.autoRotate = true;
            controls.autoRotateSpeed = 2;
            let animate = (scene, diff) => {
                controls.update(diff);
                renderer.render(scene, camera);
                requestAnimationFrame(diff => {
                    return animate(scene, diff)
                });
            };
            let render_model = async path => {
                console.log("render_model", path);
                let scene = new THREE.Scene();
                scene.add(new THREE.HemisphereLight(0xffffff, 1.5));
                let loader = new STLLoader();
                let geometry = await new Promise((r, j) => {
                    console.log("trying to load", path);
                    try {
                        loader.load(path, (geo) => {
                            console.log("resolved geo", geo);
                            return r(geo);
                        });
                    } catch (e) {
                        return j(e);
                    }
                });
                let material = new THREE.MeshPhongMaterial({
                    color: 0xff5533,
                    specular: 100,
                    shininess: 100
                });
                let mesh = new THREE.Mesh(geometry, material);
                scene.add(mesh);
                let middle = new THREE.Vector3();
                geometry.computeBoundingBox();
                geometry.boundingBox.getCenter(middle);
                mesh.geometry
                    .applyMatrix4(new THREE.Matrix4()
                        .makeTranslation(-middle.x, -middle.y, -middle.z));
                let largestDimension = Math.max(geometry.boundingBox.max.x,
                    geometry.boundingBox.max.y,
                    geometry.boundingBox.max.z)
                camera.position.z = largestDimension * 3;
                requestAnimationFrame(diff => {
                    return animate(scene, diff)
                });
            };

            for (let btn of Array.from(document.querySelectorAll(".render-button"))) {
                btn.addEventListener("click", async () => {
                    console.log("clicked", btn.dataset.path);
                    return await render_model(btn.dataset.path);
                })
            }
            
        </script>
    </body>
</html>
